# Auspex — project-structure.md

> Phase 5: Project Structure
> Date: 21.02.2026
> Status: Current

---

## Directory Layout

```
auspex/
├── cmd/
│   └── auspex/
│       ├── main.go
│       └── web/
│           ├── dist/               # gitignored (built by npm run build)
│           │   └── .gitkeep
│           ├── src/
│           │   ├── api/
│           │   │   └── client.js
│           │   ├── components/
│           │   │   ├── BlueprintTable.jsx
│           │   │   ├── CharactersSection.jsx
│           │   │   └── SummaryBar.jsx
│           │   ├── App.jsx
│           │   └── main.jsx
│           ├── index.html
│           ├── package.json
│           └── vite.config.js
├── docs
│   ├── architecture.md
│   ├── idea.md
│   ├── project-structure.md
│   ├── requirements.md
│   ├── tech-stack.md
│   └── archive/
│       └── <new_prd_name.md>
├── internal/
│   ├── api/
│   │   ├── blueprints.go
│   │   ├── characters.go
│   │   ├── corporations.go
│   │   ├── router.go
│   │   ├── static.go
│   │   └── sync.go
│   ├── auth/
│   │   ├── client.go
│   │   └── oauth.go
│   ├── config/
│   │   └── config.go
│   ├── db/
│   │   ├── db.go
│   │   ├── migrations/
│   │   │   └── 001_initial.sql
│   │   └── queries/
│   │       ├── blueprints.sql
│   │       ├── characters.sql
│   │       ├── corporations.sql
│   │       ├── jobs.sql
│   │       ├── sync_state.sql
│   │       └── universe.sql
│   ├── esi/
│   │   ├── blueprints.go
│   │   ├── client.go
│   │   ├── jobs.go
│   │   └── universe.go
│   ├── store/                      # generated by sqlc — do not edit manually
│   │   └── .gitkeep
│   └── sync/
│       └── worker.go
├── tools/
│   ├── rm.go               # cross-platform file/dir removal (go run tools/rm.go)
│   └── touch.go            # cross-platform file touch/create (go run tools/touch.go)
├── .gitignore
├── go.mod
├── Makefile
└── sqlc.yaml
```

---

## File Descriptions

### Root

| File | Purpose |
|------|---------|
| `go.mod` | Go module definition: `github.com/dpleshakov/auspex`, requires Go 1.22+ |
| `sqlc.yaml` | sqlc v2 config: reads schema from `internal/db/migrations/`, queries from `internal/db/queries/`, outputs typed Go code to `internal/store/` |
| `auspex.example.yaml` | **Created in Phase 7** when `internal/config/` is implemented. Field names are determined by the `Config` struct. The real `auspex.yaml` (with credentials) is gitignored. |
| `.gitignore` | Ignores binary, `web/dist/*` (except `.gitkeep`), `node_modules/`, `*.db`, `auspex.yaml` |
| `Makefile` | Build automation: `build`, `frontend`, `sqlc`, `test`, `lint`, `check`, `clean`, `clean-all` targets. On Windows requires `make` to be installed separately. |
| `tools/` | Go helper scripts for cross-platform build tasks. Tagged `//go:build ignore` — excluded from normal builds, invoked via `go run tools/<name>.go`. |

---

### `cmd/auspex/`

Entry point for the Auspex binary.

| File | Purpose |
|------|---------|
| `main.go` | Wires all packages together: loads config, initializes DB, starts sync worker, starts HTTP server. Contains `//go:embed all:web/dist` to embed the built frontend into the binary. |

---

### `cmd/auspex/web/`

React frontend source and build output. Lives under `cmd/auspex/` for a specific reason: Go's `//go:embed` directive cannot reference paths above the source file's directory (no `..` allowed). Placing `web/` here allows `main.go` to embed `web/dist` directly.

| File/Dir | Purpose |
|----------|---------|
| `index.html` | Vite HTML entry point |
| `package.json` | NPM dependencies: React 18, TanStack Table v8, Vite |
| `vite.config.js` | Vite config. In dev mode proxies `/api` and `/auth` to `localhost:8080` so the frontend talks to the running Go backend. |
| `dist/` | Build output — **not committed** (gitignored). Produced by `npm run build`. Embedded into the Go binary at compile time via `//go:embed`. |
| `dist/.gitkeep` | Committed to keep the `dist/` directory in the repo so `//go:embed` compiles on a fresh clone before `npm run build` has been run. |
| `src/main.jsx` | React root: mounts `<App />` into `#root` |
| `src/App.jsx` | Top-level component: composes `SummaryBar`, `CharactersSection`, `BlueprintTable` |
| `src/api/client.js` | All `fetch` calls to the backend API. Components import functions from here and never call `fetch` directly. |
| `src/components/SummaryBar.jsx` | Summary row: idle BPO count / overdue jobs / completing today / free research slots |
| `src/components/CharactersSection.jsx` | Per-character slot usage: Used / Total / Available |
| `src/components/BlueprintTable.jsx` | Main BPO table with sorting, filtering, and row highlighting via TanStack Table v8 |

---

### `internal/config/`

| File | Purpose |
|------|---------|
| `config.go` | `Config` struct and loader. Sources: CLI flags and `auspex.yaml`. Fields: port, db_path, refresh_interval, ESI client_id/client_secret/callback_url. |

---

### `internal/db/`

| File/Dir | Purpose |
|----------|---------|
| `db.go` | Opens the SQLite connection (`modernc.org/sqlite`, pure Go, no CGO). Runs migrations in order on startup. Returns `*sql.DB`. |
| `migrations/001_initial.sql` | Full DB schema: `eve_categories`, `eve_groups`, `eve_types`, `characters`, `corporations`, `blueprints`, `jobs`, `sync_state`. Migrations are up-only for MVP (no rollback). |
| `queries/blueprints.sql` | sqlc query definitions for the `blueprints` table |
| `queries/characters.sql` | sqlc query definitions for the `characters` table |
| `queries/corporations.sql` | sqlc query definitions for the `corporations` table |
| `queries/jobs.sql` | sqlc query definitions for the `jobs` table |
| `queries/sync_state.sql` | sqlc query definitions for the `sync_state` table |
| `queries/universe.sql` | sqlc query definitions for `eve_types`, `eve_groups`, `eve_categories` |

---

### `internal/store/`

**Generated by sqlc — do not edit manually.**

Regenerate after any change to `internal/db/migrations/` or `internal/db/queries/`:
```
sqlc generate
```

Imported only by `internal/api/` and `internal/sync/`. Never imported by `internal/esi/` or `internal/auth/`.

---

### `internal/esi/`

ESI HTTP client. Has no knowledge of the database.

| File | Purpose |
|------|---------|
| `client.go` | Base HTTP client: executes requests, parses the `Expires` header into `cache_until`, handles 429/5xx with retry logic |
| `blueprints.go` | `GET /characters/{id}/blueprints`, `GET /corporations/{id}/blueprints` |
| `jobs.go` | `GET /characters/{id}/industry/jobs`, `GET /corporations/{id}/industry/jobs` |
| `universe.go` | `GET /universe/types/{type_id}`, `POST /universe/names/` (bulk name resolve) |

---

### `internal/auth/`

EVE SSO OAuth2 flow.

| File | Purpose |
|------|---------|
| `oauth.go` | Authorization URL generation, code → token exchange, character verification via `GET /verify` |
| `client.go` | `auth.Client`: wraps `esi` with automatic token refresh before each request. Reads/writes tokens via `store`. |

---

### `internal/sync/`

Background sync worker and scheduler. Coordinates `auth`/`esi` and `store`.

| File | Purpose |
|------|---------|
| `worker.go` | Ticker fires every N minutes (from config). Iterates characters + corporations, checks `sync_state.cache_until`, skips if still fresh, otherwise fetches from ESI and upserts to DB. Accepts force-refresh signal via channel from `api`. After each successful sync, triggers lazy resolution of unknown `type_id`s. |

Note: if stdlib `sync` is needed inside this package, alias it: `import stdsync "sync"`.

---

### `internal/api/`

Chi router and HTTP handlers. Never calls ESI directly — reads only from `store`.

| File | Purpose |
|------|---------|
| `router.go` | Assembles the Chi router, registers middleware (Logger, Recoverer, CORS, JSON content-type for `/api` routes), mounts all handlers |
| `static.go` | Serves the embedded frontend (`embed.FS` passed in from `main.go`). Non-API routes fall through to `index.html` (SPA routing). |
| `characters.go` | `GET /api/characters`, `DELETE /api/characters/{id}` |
| `corporations.go` | `GET /api/corporations`, `POST /api/corporations`, `DELETE /api/corporations/{id}` |
| `blueprints.go` | `GET /api/blueprints` (filters: status, owner_id, owner_type, category_id), `GET /api/jobs/summary` |
| `sync.go` | `POST /api/sync` (sends signal to sync worker), `GET /api/sync/status` |

---

### `tools/`

Go helper scripts for cross-platform build automation. Each file carries `//go:build ignore`
so it is excluded from `go build ./...` but can be invoked directly via `go run`:

| File | Purpose |
|------|---------|
| `rm.go` | Removes files or directories. Flag `-r` enables recursive removal. Missing paths are silently skipped (like `rm -f`). |
| `touch.go` | Creates a file (and any missing parent directories). Updates mtime if the file already exists. |

---

### `Makefile`

Top-level build automation. Targets:

| Target | Action |
|--------|--------|
| `build` | Full build: `frontend` → `sqlc` → `go build -o auspex ./cmd/auspex/` |
| `frontend` | `npm install && npm run build` inside `cmd/auspex/web/` |
| `sqlc` | `sqlc generate` |
| `test` | `go test ./...` |
| `lint` | `lint-go` + `lint-js` |
| `lint-go` | `go vet ./...` + `golangci-lint run` |
| `lint-js` | `npm audit --audit-level=high` |
| `check` | `lint` + `test` + `build` (run before pushing) |
| `clean` | Removes binary and rebuilds `web/dist/` with only `.gitkeep`. Uses `go run tools/rm.go` and `go run tools/touch.go` for cross-platform compatibility. |
| `clean-all` | `clean` + removes `auspex.db` |

**Build order matters:** the frontend must be built before `go build` so that `web/dist/` contains real files for `//go:embed`. `sqlc generate` must run before `go build` so that `internal/store/` contains generated code.
